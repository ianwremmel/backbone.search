/*! backbone.search - v0.1.0-pre - 2013-05-24
* https://github.com/boazsender/backbone.search
* Copyright (c) 2013 Boaz Sender; Licensed MIT */
(function(e,t,n,r){e.Model.prototype.clearSearchScore=function(t){this.off(null,e.Model.prototype.clearSearchScore,this),this.unset("searchScore"),this.unset("searchTerm")},e.Model.prototype.getSearchScore=function(n){if(this.has("searchScore")&&this.has("searchTerm")&&this.get("searchTerm")===n)return this.get("searchScore");var r=this.searchFields?this.pick(this.searchFields):this.toJSON(),i=JSON.stringify(t.values(r)).toLowerCase(),s=i.score(n);this.set({searchScore:s,searchTerm:n});if(this.searchFields)for(var o=0;o<this.searchFields.length;o++)this.on("change:"+this.searchFields[o],e.Model.prototype.clearSearchScore,this);else this.on("change",e.Model.prototype.clearSearchScore,this);return s},e.Collection.prototype.search=function(t){t=n.trim(t.toLowerCase());var r=new e.Collection;return r.comparator=function(e){return-1*e.getSearchScore(t)},t&&this.each(function(e){e.getSearchScore(t)>0&&r.add(e,{sort:!1})}),r.sort(),r},String.prototype.score=function(e){if(e.length===0)return.9;if(e.length>this.length)return 0;for(var t=e.length;t>0;t--){var n=e.substring(0,t),r=this.indexOf(n);if(r<0)continue;if(r+e.length>this.length)continue;var i=this.substring(r+n.length),s=null;t>=e.length?s="":s=e.substring(t);var o=i.score(s,r);if(o>0){var u=this.length-i.length;if(r!==0){var a=0,f=this.charCodeAt(r-1);if(f===32||f===9)for(a=r-2;a>=0;a--)f=this.charCodeAt(a),u-=f===32||f===9?1:.15;else u-=r}return u+=o*i.length,u/=this.length,u}}return 0}})(Backbone,_,jQuery);